# 总账模块功能文档

## 📊 功能概述

总账模块是JCIKL会计系统的核心组件，提供完整的财务交易记录管理和报表功能。该模块已实现高级筛选和导出功能，支持多种数据格式和权限控制。

## 🎯 主要功能

### 1. 高级筛选功能

#### 1.1 日期范围筛选
- **功能**: 按交易日期范围筛选记录
- **支持格式**: YYYY-MM-DD
- **筛选逻辑**: 开始日期 ≤ 交易日期 ≤ 结束日期
- **UI组件**: 日期选择器

#### 1.2 金额范围筛选
- **功能**: 按交易金额范围筛选记录
- **支持类型**: 借方金额、贷方金额
- **筛选逻辑**: 最小金额 ≤ 交易金额 ≤ 最大金额
- **UI组件**: 数字输入框

#### 1.3 状态筛选
- **支持状态**: Completed（已完成）、Pending（待处理）、Draft（草稿）
- **筛选逻辑**: 多选状态筛选
- **UI组件**: 复选框组

#### 1.4 类别筛选
- **功能**: 按交易类别筛选记录
- **动态类别**: 根据实际数据动态生成类别列表
- **筛选逻辑**: 多选类别筛选
- **UI组件**: 复选框组

#### 1.5 账户筛选
- **功能**: 按账户筛选交易记录
- **数据源**: 从账户图表获取账户列表
- **筛选逻辑**: 多选账户筛选
- **UI组件**: 复选框组

### 2. 导出功能

#### 2.1 CSV导出
- **格式**: 标准CSV格式
- **编码**: UTF-8
- **字段**: 日期、交易ID、描述、账户、借方、贷方、状态、类别、参考
- **文件名**: `总账报表_YYYY-MM-DD.csv`

#### 2.2 Excel导出
- **格式**: XLSX格式
- **功能**: 使用xlsx库生成专业Excel文件
- **特性**: 
  - 自动列宽设置
  - 工作表命名
  - 数据格式化
- **文件名**: `总账报表_YYYY-MM-DD.xlsx`

#### 2.3 PDF导出
- **格式**: PDF格式
- **功能**: 使用jsPDF库生成专业PDF报表
- **特性**:
  - 横向布局
  - 表格格式
  - 标题和页脚
  - 筛选条件信息
  - 分页支持
- **文件名**: `总账报表_YYYY-MM-DD.pdf`

### 3. 权限控制

#### 3.1 访问权限
- **Level 1**: 财务主管、总裁、秘书 - 可查看所有数据
- **Level 2**: 副总裁 - 可查看和导出数据
- **Level 3**: 助理副总裁、项目主席 - 仅可查看数据

#### 3.2 功能权限
- **高级筛选**: 所有级别用户可用
- **导出功能**: 仅Level 2及以上用户可用
- **数据查看**: 所有级别用户可用

### 4. 用户界面特性

#### 4.1 筛选状态指示
- **活跃筛选**: 按钮高亮显示
- **筛选计数**: 显示活跃筛选条件数量
- **筛选标签**: 显示当前应用的筛选条件

#### 4.2 导出进度
- **进度条**: 实时显示导出进度
- **状态提示**: 显示当前导出状态
- **完成通知**: 导出完成后自动关闭对话框

#### 4.3 响应式设计
- **移动端**: 适配移动设备
- **桌面端**: 完整功能支持
- **平板端**: 中等屏幕优化

## 🔧 技术实现

### 前端技术栈
- **框架**: Next.js 15.2.4
- **UI库**: Radix UI + Tailwind CSS
- **状态管理**: React Hooks
- **导出库**: xlsx, jsPDF, html2canvas

### 数据流
1. **数据获取**: 从Firebase Firestore获取交易和账户数据
2. **筛选处理**: 使用React.useMemo优化筛选性能
3. **导出处理**: 客户端生成文件并下载
4. **权限验证**: 基于用户角色的功能访问控制

### 性能优化
- **虚拟滚动**: 大数据量时的性能优化
- **记忆化筛选**: 避免不必要的重新计算
- **懒加载**: 按需加载组件和数据

## 📋 使用指南

### 基本操作流程

1. **访问总账模块**
   - 登录系统后，在侧边栏选择"General Ledger"
   - 确保有相应权限访问

2. **应用基础筛选**
   - 使用搜索框搜索交易描述或账户
   - 使用账户下拉菜单选择特定账户

3. **使用高级筛选**
   - 点击"高级筛选"按钮
   - 设置日期范围、金额范围、状态等条件
   - 点击"应用筛选"确认

4. **导出数据**
   - 点击"导出"按钮（需要相应权限）
   - 选择导出格式（CSV/Excel/PDF）
   - 等待导出完成并下载文件

### 筛选条件组合

#### 示例1: 特定时间段的已完成交易
```
日期范围: 2024-01-01 到 2024-01-31
状态: Completed
```

#### 示例2: 高价值交易
```
金额范围: 10000 到 100000
状态: Completed
```

#### 示例3: 特定类别的交易
```
类别: 办公费用
状态: Completed, Pending
```

## 🚀 功能特性

### ✅ 已实现功能
- [x] 高级筛选对话框
- [x] 多条件组合筛选
- [x] 实时筛选结果更新
- [x] 筛选状态可视化
- [x] CSV导出功能
- [x] Excel导出功能
- [x] PDF导出功能
- [x] 导出进度显示
- [x] 权限控制
- [x] 响应式设计
- [x] 错误处理

### 🔄 待优化功能
- [ ] 筛选条件保存
- [ ] 导出历史记录
- [ ] 批量操作功能
- [ ] 数据验证增强
- [ ] 性能监控

## 🐛 已知问题

1. **localStorage错误**: 在服务器端渲染时出现localStorage未定义错误
   - **影响**: 不影响核心功能
   - **解决方案**: 已在客户端处理

2. **大数据量性能**: 大量数据时筛选可能较慢
   - **影响**: 用户体验
   - **解决方案**: 已实现虚拟滚动优化

## 📊 测试数据

### 测试账户
```javascript
const testAccounts = [
  { code: '1001', name: '现金', type: 'Asset', balance: 15000 },
  { code: '1002', name: '银行存款', type: 'Asset', balance: 50000 },
  { code: '2001', name: '应付账款', type: 'Liability', balance: 8000 },
  { code: '3001', name: '实收资本', type: 'Equity', balance: 100000 },
  { code: '4001', name: '营业收入', type: 'Revenue', balance: 25000 }
];
```

### 测试交易
```javascript
const testTransactions = [
  { id: 'TXN001', date: '2024-01-15', description: '办公用品采购', account: '办公费用', debit: 500, credit: 0, status: 'Completed' },
  { id: 'TXN002', date: '2024-01-16', description: '客户付款', account: '应收账款', debit: 0, credit: 2000, status: 'Completed' },
  { id: 'TXN003', date: '2024-01-17', description: '员工工资', account: '工资费用', debit: 3000, credit: 0, status: 'Pending' }
];
```

## 🔮 未来规划

### 短期目标
1. 添加筛选条件保存功能
2. 优化大数据量性能
3. 增加更多导出格式支持

### 长期目标
1. 集成AI辅助分析
2. 添加数据可视化图表
3. 支持自定义报表模板

## 📞 技术支持

如有问题或建议，请联系开发团队或查看相关文档：
- [Firebase设置指南](./firebase-setup-guide.md)
- [自定义认证指南](./custom-auth-guide.md)
- [快速Firebase设置](./quick-firebase-setup.md) 