
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢æ€§èƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .metric.good { border-left: 4px solid #28a745; }
        .metric.warning { border-left: 4px solid #ffc107; }
        .metric.poor { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <h1>é¡µé¢æ€§èƒ½æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•é¡¹ç›®è´¦æˆ·é¡µé¢å’Œè´¦æˆ·å›¾è¡¨é¡µé¢çš„æ€§èƒ½è¡¨ç°ã€‚</p>
        <p>è¯·å…ˆå¯¼èˆªåˆ°è¦æµ‹è¯•çš„é¡µé¢ï¼Œç„¶åç‚¹å‡»ç›¸åº”çš„æµ‹è¯•æŒ‰é’®ã€‚</p>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•æ“ä½œ</h2>
        <button class="test-button" onclick="runPerformanceTest()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
        <button class="test-button" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        <button class="test-button" onclick="exportResults()">å¯¼å‡ºç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="results" class="results">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script>
        
// é¡µé¢æ€§èƒ½æµ‹è¯•è„šæœ¬
(function() {
  console.log('ğŸš€ å¼€å§‹é¡µé¢æ€§èƒ½æµ‹è¯•...');
  
  const testResults = {
    timestamp: new Date().toISOString(),
    url: window.location.href,
    userAgent: navigator.userAgent,
    metrics: {}
  };

  // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
  function waitForPageLoad() {
    return new Promise((resolve) => {
      if (document.readyState === 'complete') {
        resolve();
      } else {
        window.addEventListener('load', resolve);
      }
    });
  }

  // æ”¶é›†æ€§èƒ½æŒ‡æ ‡
  function collectMetrics() {
    const navigation = performance.getEntriesByType('navigation')[0];
    const paint = performance.getEntriesByType('paint');
    const memory = performance.memory;
    
    return {
      loadTime: navigation.loadEventEnd - navigation.loadEventStart,
      domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
      firstPaint: paint.find(p => p.name === 'first-paint')?.startTime || 0,
      firstContentfulPaint: paint.find(p => p.name === 'first-contentful-paint')?.startTime || 0,
      memoryUsage: memory ? memory.usedJSHeapSize / memory.jsHeapSizeLimit : 0,
      totalMemory: memory ? memory.jsHeapSizeLimit : 0,
      usedMemory: memory ? memory.usedJSHeapSize : 0,
      errors: window.performance.getEntriesByType('resource').filter(r => !r.responseEnd).length
    };
  }

  // æµ‹è¯•é¡µé¢äº¤äº’æ€§èƒ½
  async function testInteractionPerformance() {
    const interactionTests = [];
    
    // æµ‹è¯•æœç´¢åŠŸèƒ½
    const searchInput = document.querySelector('input[placeholder*="æœç´¢"]');
    if (searchInput) {
      const startTime = performance.now();
      searchInput.focus();
      searchInput.value = 'test';
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      await new Promise(resolve => setTimeout(resolve, 100));
      const endTime = performance.now();
      interactionTests.push({
        name: 'æœç´¢è¾“å…¥å“åº”',
        duration: endTime - startTime
      });
    }

    // æµ‹è¯•è¡¨æ ¼æ¸²æŸ“
    const tables = document.querySelectorAll('table');
    if (tables.length > 0) {
      const startTime = performance.now();
      const rows = tables[0].querySelectorAll('tbody tr');
      const endTime = performance.now();
      interactionTests.push({
        name: 'è¡¨æ ¼æ¸²æŸ“',
        duration: endTime - startTime,
        rowCount: rows.length
      });
    }

    return interactionTests;
  }

  // ä¸»æµ‹è¯•å‡½æ•°
  async function runPerformanceTest() {
    await waitForPageLoad();
    
    // ç­‰å¾…é¢å¤–æ—¶é—´ç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½åŠ è½½å®Œæˆ
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const metrics = collectMetrics();
    const interactions = await testInteractionPerformance();
    
    testResults.metrics = {
      ...metrics,
      interactions
    };

    // æ£€æµ‹å½“å‰é¡µé¢ç±»å‹
    const projectAccountsElement = document.querySelector('[data-testid="project-accounts"]');
    const accountChartElement = document.querySelector('[data-testid="account-chart"]');
    
    if (projectAccountsElement) {
      testResults.pageType = 'project-accounts';
    } else if (accountChartElement) {
      testResults.pageType = 'account-chart';
    } else {
      testResults.pageType = 'unknown';
    }

    console.log('ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ:', testResults);
    
    // å°†ç»“æœå‘é€åˆ°æœåŠ¡å™¨æˆ–ä¿å­˜åˆ° localStorage
    localStorage.setItem('performanceTestResults', JSON.stringify(testResults));
    
    // æ˜¾ç¤ºç»“æœåœ¨é¡µé¢ä¸Š
    displayResults(testResults);
  }

  // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºç»“æœ
  function displayResults(results) {
    const resultsDiv = document.createElement('div');
    resultsDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 20px;
      max-width: 400px;
      z-index: 10000;
      font-family: monospace;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    const metrics = results.metrics;
    resultsDiv.innerHTML = `
      <h3 style="margin: 0 0 10px 0; color: #007bff;">æ€§èƒ½æµ‹è¯•ç»“æœ</h3>
      <p><strong>é¡µé¢ç±»å‹:</strong> ${results.pageType}</p>
      <p><strong>åŠ è½½æ—¶é—´:</strong> ${metrics.loadTime.toFixed(2)}ms</p>
      <p><strong>DOMå†…å®¹åŠ è½½:</strong> ${metrics.domContentLoaded.toFixed(2)}ms</p>
      <p><strong>é¦–æ¬¡ç»˜åˆ¶:</strong> ${metrics.firstPaint.toFixed(2)}ms</p>
      <p><strong>é¦–æ¬¡å†…å®¹ç»˜åˆ¶:</strong> ${metrics.firstContentfulPaint.toFixed(2)}ms</p>
      <p><strong>å†…å­˜ä½¿ç”¨ç‡:</strong> ${(metrics.memoryUsage * 100).toFixed(2)}%</p>
      <p><strong>é”™è¯¯æ•°é‡:</strong> ${metrics.errors}</p>
      ${metrics.interactions.map(i => `<p><strong>${i.name}:</strong> ${i.duration.toFixed(2)}ms${i.rowCount ? ` (${i.rowCount} è¡Œ)` : ''}</p>`).join('')}
      <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
    `;
    
    document.body.appendChild(resultsDiv);
  }

  // å¼€å§‹æµ‹è¯•
  runPerformanceTest();
})();


        function runPerformanceTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent = 'æ­£åœ¨è¿è¡Œæµ‹è¯•...';
            
            // è¿è¡Œæ€§èƒ½æµ‹è¯•è„šæœ¬
            eval(`(
// é¡µé¢æ€§èƒ½æµ‹è¯•è„šæœ¬
(function() {
  console.log('ğŸš€ å¼€å§‹é¡µé¢æ€§èƒ½æµ‹è¯•...');
  
  const testResults = {
    timestamp: new Date().toISOString(),
    url: window.location.href,
    userAgent: navigator.userAgent,
    metrics: {}
  };

  // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
  function waitForPageLoad() {
    return new Promise((resolve) => {
      if (document.readyState === 'complete') {
        resolve();
      } else {
        window.addEventListener('load', resolve);
      }
    });
  }

  // æ”¶é›†æ€§èƒ½æŒ‡æ ‡
  function collectMetrics() {
    const navigation = performance.getEntriesByType('navigation')[0];
    const paint = performance.getEntriesByType('paint');
    const memory = performance.memory;
    
    return {
      loadTime: navigation.loadEventEnd - navigation.loadEventStart,
      domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
      firstPaint: paint.find(p => p.name === 'first-paint')?.startTime || 0,
      firstContentfulPaint: paint.find(p => p.name === 'first-contentful-paint')?.startTime || 0,
      memoryUsage: memory ? memory.usedJSHeapSize / memory.jsHeapSizeLimit : 0,
      totalMemory: memory ? memory.jsHeapSizeLimit : 0,
      usedMemory: memory ? memory.usedJSHeapSize : 0,
      errors: window.performance.getEntriesByType('resource').filter(r => !r.responseEnd).length
    };
  }

  // æµ‹è¯•é¡µé¢äº¤äº’æ€§èƒ½
  async function testInteractionPerformance() {
    const interactionTests = [];
    
    // æµ‹è¯•æœç´¢åŠŸèƒ½
    const searchInput = document.querySelector('input[placeholder*="æœç´¢"]');
    if (searchInput) {
      const startTime = performance.now();
      searchInput.focus();
      searchInput.value = 'test';
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      await new Promise(resolve => setTimeout(resolve, 100));
      const endTime = performance.now();
      interactionTests.push({
        name: 'æœç´¢è¾“å…¥å“åº”',
        duration: endTime - startTime
      });
    }

    // æµ‹è¯•è¡¨æ ¼æ¸²æŸ“
    const tables = document.querySelectorAll('table');
    if (tables.length > 0) {
      const startTime = performance.now();
      const rows = tables[0].querySelectorAll('tbody tr');
      const endTime = performance.now();
      interactionTests.push({
        name: 'è¡¨æ ¼æ¸²æŸ“',
        duration: endTime - startTime,
        rowCount: rows.length
      });
    }

    return interactionTests;
  }

  // ä¸»æµ‹è¯•å‡½æ•°
  async function runPerformanceTest() {
    await waitForPageLoad();
    
    // ç­‰å¾…é¢å¤–æ—¶é—´ç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½åŠ è½½å®Œæˆ
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const metrics = collectMetrics();
    const interactions = await testInteractionPerformance();
    
    testResults.metrics = {
      ...metrics,
      interactions
    };

    // æ£€æµ‹å½“å‰é¡µé¢ç±»å‹
    const projectAccountsElement = document.querySelector('[data-testid="project-accounts"]');
    const accountChartElement = document.querySelector('[data-testid="account-chart"]');
    
    if (projectAccountsElement) {
      testResults.pageType = 'project-accounts';
    } else if (accountChartElement) {
      testResults.pageType = 'account-chart';
    } else {
      testResults.pageType = 'unknown';
    }

    console.log('ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ:', testResults);
    
    // å°†ç»“æœå‘é€åˆ°æœåŠ¡å™¨æˆ–ä¿å­˜åˆ° localStorage
    localStorage.setItem('performanceTestResults', JSON.stringify(testResults));
    
    // æ˜¾ç¤ºç»“æœåœ¨é¡µé¢ä¸Š
    displayResults(testResults);
  }

  // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºç»“æœ
  function displayResults(results) {
    const resultsDiv = document.createElement('div');
    resultsDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 20px;
      max-width: 400px;
      z-index: 10000;
      font-family: monospace;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    const metrics = results.metrics;
    resultsDiv.innerHTML = `
      <h3 style="margin: 0 0 10px 0; color: #007bff;">æ€§èƒ½æµ‹è¯•ç»“æœ</h3>
      <p><strong>é¡µé¢ç±»å‹:</strong> ${results.pageType}</p>
      <p><strong>åŠ è½½æ—¶é—´:</strong> ${metrics.loadTime.toFixed(2)}ms</p>
      <p><strong>DOMå†…å®¹åŠ è½½:</strong> ${metrics.domContentLoaded.toFixed(2)}ms</p>
      <p><strong>é¦–æ¬¡ç»˜åˆ¶:</strong> ${metrics.firstPaint.toFixed(2)}ms</p>
      <p><strong>é¦–æ¬¡å†…å®¹ç»˜åˆ¶:</strong> ${metrics.firstContentfulPaint.toFixed(2)}ms</p>
      <p><strong>å†…å­˜ä½¿ç”¨ç‡:</strong> ${(metrics.memoryUsage * 100).toFixed(2)}%</p>
      <p><strong>é”™è¯¯æ•°é‡:</strong> ${metrics.errors}</p>
      ${metrics.interactions.map(i => `<p><strong>${i.name}:</strong> ${i.duration.toFixed(2)}ms${i.rowCount ? ` (${i.rowCount} è¡Œ)` : ''}</p>`).join('')}
      <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
    `;
    
    document.body.appendChild(resultsDiv);
  }

  // å¼€å§‹æµ‹è¯•
  runPerformanceTest();
})();
)`);
            
            // ç­‰å¾…ç»“æœ
            setTimeout(() => {
                const results = localStorage.getItem('performanceTestResults');
                if (results) {
                    displayFormattedResults(JSON.parse(results));
                } else {
                    resultsDiv.textContent = 'æµ‹è¯•å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ç»“æœã€‚è¯·æ£€æŸ¥æ§åˆ¶å°è¾“å‡ºã€‚';
                }
            }, 3000);
        }

        function displayFormattedResults(results) {
            const resultsDiv = document.getElementById('results');
            const metrics = results.metrics;
            
            const getPerformanceClass = (value, good, warning) => {
                if (value <= good) return 'good';
                if (value <= warning) return 'warning';
                return 'poor';
            };

            let html = `
æµ‹è¯•æ—¶é—´: ${new Date(results.timestamp).toLocaleString()}
é¡µé¢ç±»å‹: ${results.pageType}
URL: ${results.url}

æ€§èƒ½æŒ‡æ ‡:
`;

            // æ·»åŠ æ€§èƒ½æŒ‡æ ‡
            const metricsList = [
                { name: 'é¡µé¢åŠ è½½æ—¶é—´', value: metrics.loadTime, unit: 'ms', good: 2000, warning: 4000 },
                { name: 'DOMå†…å®¹åŠ è½½', value: metrics.domContentLoaded, unit: 'ms', good: 1000, warning: 2000 },
                { name: 'é¦–æ¬¡ç»˜åˆ¶', value: metrics.firstPaint, unit: 'ms', good: 1000, warning: 2000 },
                { name: 'é¦–æ¬¡å†…å®¹ç»˜åˆ¶', value: metrics.firstContentfulPaint, unit: 'ms', good: 1000, warning: 2000 },
                { name: 'å†…å­˜ä½¿ç”¨ç‡', value: metrics.memoryUsage * 100, unit: '%', good: 70, warning: 90 },
                { name: 'é”™è¯¯æ•°é‡', value: metrics.errors, unit: '', good: 0, warning: 5 }
            ];

            metricsList.forEach(metric => {
                const className = getPerformanceClass(metric.value, metric.good, metric.warning);
                html += `
<div class="metric ${className}">
    <span>${metric.name}:</span>
    <span>${metric.value.toFixed(2)}${metric.unit}</span>
</div>`;
            });

            // æ·»åŠ äº¤äº’æµ‹è¯•ç»“æœ
            if (metrics.interactions && metrics.interactions.length > 0) {
                html += `\näº¤äº’æ€§èƒ½æµ‹è¯•:\n`;
                metrics.interactions.forEach(interaction => {
                    html += `<div class="metric">${interaction.name}: ${interaction.duration.toFixed(2)}ms${interaction.rowCount ? ` (${interaction.rowCount} è¡Œ)` : ''}</div>`;
                });
            }

            resultsDiv.innerHTML = html;
        }

        function clearResults() {
            localStorage.removeItem('performanceTestResults');
            document.getElementById('results').textContent = 'ç»“æœå·²æ¸…é™¤';
        }

        function exportResults() {
            const results = localStorage.getItem('performanceTestResults');
            if (results) {
                const blob = new Blob([results], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `performance-test-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
            }
        }
    </script>
</body>
</html>
